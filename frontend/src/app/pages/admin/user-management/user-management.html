<div class="user-management-container">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <div class="header-section">
        <h1 class="page-title">
            <i class="pi pi-users"></i>
            Gestión de Usuarios
        </h1>
        <p class="page-subtitle">Administre los usuarios del sistema</p>
    </div>

    <p-card>
        <p-toolbar>
            <ng-template pTemplate="left">
                <button 
                    pButton 
                    label="Nuevo Usuario" 
                    icon="pi pi-plus" 
                    class="p-button-success"
                    (click)="openNew()">
                </button>
            </ng-template>

            <ng-template pTemplate="right">
                <p-iconfield iconPosition="left">
                    <p-inputicon styleClass="pi pi-search" />
                    <input 
                        pInputText 
                        type="text" 
                        #filter
                        (input)="onGlobalFilter(dt, $event)" 
                        placeholder="Buscar..." 
                        class="search-input" />
                </p-iconfield>
            </ng-template>
        </p-toolbar>

        <p-table 
            #dt
            [value]="usuarios" 
            [rows]="10" 
            [paginator]="true"
            [globalFilterFields]="['nombre','apellido','username','email','rol']"
            [tableStyle]="{ 'min-width': '75rem' }"
            [loading]="loading"
            [rowHover]="true"
            responsiveLayout="scroll"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
            [showCurrentPageReport]="true">
            
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="nombre" style="width: 15%">
                        Nombre <p-sortIcon field="nombre"></p-sortIcon>
                    </th>
                    <th pSortableColumn="apellido" style="width: 15%">
                        Apellido <p-sortIcon field="apellido"></p-sortIcon>
                    </th>
                    <th pSortableColumn="username" style="width: 12%">
                        Usuario <p-sortIcon field="username"></p-sortIcon>
                    </th>
                    <th pSortableColumn="email" style="width: 18%">
                        Email <p-sortIcon field="email"></p-sortIcon>
                    </th>
                    <th pSortableColumn="telefono" style="width: 12%">
                        Teléfono <p-sortIcon field="telefono"></p-sortIcon>
                    </th>
                    <th pSortableColumn="rol" style="width: 10%; text-align: center;">
                        Rol <p-sortIcon field="rol"></p-sortIcon>
                    </th>
                    <th pSortableColumn="activo" style="width: 8%">
                        Estado <p-sortIcon field="activo"></p-sortIcon>
                    </th>
                    <th style="width: 10%">Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-usuario>
                <tr>
                    <td>{{ usuario.nombre }}</td>
                    <td>{{ usuario.apellido }}</td>
                    <td>
                        <span class="username-badge">
                            <i class="pi pi-user"></i>
                            {{ usuario.username }}
                        </span>
                    </td>
                    <td>{{ usuario.email || '-' }}</td>
                    <td>{{ usuario.telefono || '-' }}</td>
                    <td style="text-align: center;">
                        <p-tag 
                            [value]="usuario.rol?.nombre || 'Sin rol'" 
                            [severity]="getRolSeverity(usuario)">
                        </p-tag>
                    </td>
                    <td>
                        <p-tag 
                            [value]="usuario.activo ? 'Activo' : 'Inactivo'" 
                            [severity]="getEstadoSeverity(usuario.activo)">
                        </p-tag>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button 
                                pButton 
                                icon="pi pi-pencil" 
                                class="p-button-rounded p-button-text p-button-warning"
                                (click)="editUsuario(usuario)"
                                pTooltip="Editar"
                                tooltipPosition="top">
                            </button>
                            <button 
                                *ngIf="usuario.activo"
                                pButton 
                                icon="pi pi-times" 
                                class="p-button-rounded p-button-text p-button-danger"
                                (click)="deleteUsuario(usuario)"
                                pTooltip="Desactivar"
                                tooltipPosition="top">
                            </button>
                            <button 
                                *ngIf="!usuario.activo"
                                pButton 
                                icon="pi pi-check" 
                                class="p-button-rounded p-button-text p-button-success"
                                (click)="activarUsuario(usuario)"
                                pTooltip="Activar"
                                tooltipPosition="top">
                            </button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8" class="empty-message">
                        <i class="pi pi-info-circle"></i>
                        No se encontraron usuarios
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>

    <!-- Dialog para crear/editar usuario -->
    <p-dialog 
        [(visible)]="usuarioDialog" 
        [header]="isEditMode ? 'Editar Usuario' : 'Nuevo Usuario'"
        [styleClass]="dialogHeaderClass"
        [contentStyle]="dialogHeaderStyle"
        [modal]="true" 
        [style]="{ width: '600px' }"
        [draggable]="false"
        [resizable]="false">
        
        <div [formGroup]="form">
            <div class="form-grid">
                <div class="form-row">
                    <div class="form-field">
                        <label for="nombre" class="required">Nombre</label>
                        <input 
                            id="nombre" 
                            type="text" 
                            pInputText 
                            formControlName="nombre"
                            [class.ng-invalid]="submitted && form.get('nombre')?.invalid"
                            placeholder="Ingrese el nombre" />
                        <small class="p-error" *ngIf="submitted && form.get('nombre')?.hasError('required')">
                            Nombre es requerido
                        </small>
                    </div>

                    <div class="form-field">
                        <label for="apellido" class="required">Apellido</label>
                        <input 
                            id="apellido" 
                            type="text" 
                            pInputText 
                            formControlName="apellido"
                            [class.ng-invalid]="submitted && form.get('apellido')?.invalid"
                            placeholder="Ingrese el apellido" />
                        <small class="p-error" *ngIf="submitted && form.get('apellido')?.hasError('required')">
                            Apellido es requerido
                        </small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label for="username" class="required">Usuario</label>
                        <input 
                            id="username" 
                            type="text" 
                            pInputText 
                            formControlName="username"
                            [class.ng-invalid]="submitted && form.get('username')?.invalid"
                            placeholder="Nombre de usuario" />
                        <small class="p-error" *ngIf="submitted && form.get('username')?.hasError('required')">
                            Usuario es requerido
                        </small>
                    </div>

                    <div class="form-field">
                        <label for="rol_id" class="required">Rol</label>
                        <p-select 
                            id="rol_id"
                            formControlName="rol_id" 
                            [options]="roles"
                            optionLabel="label"
                            optionValue="value"
                            placeholder="Seleccione un rol"
                            [loading]="rolesLoading"
                            appendTo="body"
                            [showClear]="false"
                            [filter]="true"
                            filterPlaceholder="Buscar rol"
                            [style]="{'width': '100%'}">
                        </p-select>
                        <small class="p-error" *ngIf="submitted && form.get('rol_id')?.hasError('required')">
                            Rol es requerido
                        </small>
                    </div>
                </div>

                <div class="form-field full-width">
                    <label for="password" [class.required]="!isEditMode">
                        Contraseña {{ isEditMode ? '(dejar vacío para no cambiar)' : '' }}
                    </label>
                    <p-password 
                        id="password"
                        formControlName="password"
                        [toggleMask]="true"
                        [feedback]="!isEditMode"
                        placeholder="Ingrese la contraseña"
                        [style]="{'width': '100%'}"
                        [inputStyle]="{'width': '100%'}">
                    </p-password>
                    <small class="p-error" *ngIf="submitted && form.get('password')?.hasError('required')">
                        Contraseña es requerida
                    </small>
                    <small class="p-error" *ngIf="submitted && form.get('password')?.hasError('minlength')">
                        Contraseña debe tener al menos 6 caracteres
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label for="email">Email</label>
                        <input 
                            id="email" 
                            type="email" 
                            pInputText 
                            formControlName="email"
                            placeholder="correo@ejemplo.com" />
                        <small class="p-error" *ngIf="submitted && form.get('email')?.hasError('email')">
                            Email inválido
                        </small>
                    </div>

                    <div class="form-field">
                        <label for="telefono">Teléfono</label>
                        <input 
                            id="telefono" 
                            type="text" 
                            pInputText 
                            formControlName="telefono"
                            placeholder="0000-0000" />
                    </div>
                </div>

                <div class="form-field full-width">
                    <label for="fecha_contratacion">Fecha de Contratación</label>
                    <input 
                        id="fecha_contratacion" 
                        type="date" 
                        pInputText 
                        formControlName="fecha_contratacion" />
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <button 
                pButton 
                label="Cancelar" 
                icon="pi pi-times" 
                class="p-button-text"
                type="button"
                (click)="hideDialog()">
            </button>
            <button 
                pButton 
                label="Guardar" 
                icon="pi pi-check" 
                class="p-button-success"
                type="button"
                (click)="saveUsuario()">
            </button>
        </ng-template>
    </p-dialog>
</div>
